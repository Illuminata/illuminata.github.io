<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>d҉o҉o҉m҉ - Pre-rendered</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    html, body { width: 100%; height: 100%; background: #000; overflow: hidden; font-family: 'Courier New', monospace; }
    .ascii-container { position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; background: #000; cursor: pointer; }
    .ascii-content {
      color: #00ff00; white-space: pre; font-family: inherit;
      font-size: clamp(6px, 1vmin, 12px); line-height: 1;
      width: 100%; height: 100%; display: block; opacity: 0; transition: opacity 0.2s ease;
      text-align: left; letter-spacing: 0; margin: 0; padding: 0;
      position: absolute; top: 0; left: 0;
    }
    .ascii-content.ready { opacity: 1; }
    .loading { 
      color: #00ff00; 
      position: fixed; top: 50%; left: 50%; 
      transform: translate(-50%, -50%); 
      font-size: 18px; 
      z-index: 1000;
    }
    @media (prefers-reduced-motion: reduce) { .ascii-content { transition: none; } }
  </style>
</head>
<body>
  <div class="ascii-container" id="asciiContainer">
    <div class="ascii-content" id="ascii"></div>
  </div>
  <div class="loading" id="loading">Loading...</div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/pako/2.1.0/pako.min.js"></script>
  <script>
    document.addEventListener('DOMContentLoaded', function() {
      const ascii = document.getElementById('ascii');
      const loading = document.getElementById('loading');
      const container = document.getElementById('asciiContainer');
      
      // DEBUG: Verify DOM works
      console.log('Elements loaded:', {ascii, container, loading});
      ascii.style.background = 'red';
      ascii.textContent = 'DOM OK - WAITING FOR FRAMES';
      
      const CHARS = ' .:-=+*#%@';
      let direction = 1;
      const FPS = 30;
      const frameDuration = 1000 / FPS;
      let lastTime = 0;
      let playing = true;
      let frames = [];
      let frameCache = new Map();
      let videoTime = 0;
      
      function computeDimensions() {
        const fontSize = parseFloat(getComputedStyle(ascii).fontSize) || 8;
        const charWidth = fontSize * 0.6;
        const charHeight = fontSize;
        return { 
          width: Math.ceil(window.innerWidth / charWidth), 
          height: Math.ceil(window.innerHeight / charHeight) 
        };
      }
      
      function resampleFrame(baseFrame, targetW, targetH) {
        const key = `${targetW}x${targetH}`;
        if (frameCache.has(key)) return frameCache.get(key);
        
        const baseLines = baseFrame.data.split('\n');
        const baseW = baseFrame.width || 120;
        const baseH = baseFrame.height || 80;
        
        const grid = [];
        for (let y = 0; y < targetH; y++) {
          const row = [];
          for (let x = 0; x < targetW; x++) {
            const srcX = Math.floor(x * baseW / targetW);
            const srcY = Math.floor(y * baseH / targetH);
            const char = baseLines[srcY]?.[srcX] || ' ';
            const charIdx = CHARS.indexOf(char);
            row.push(CHARS[charIdx >= 0 ? charIdx : 0]);
          }
          grid.push(row.join(''));
        }
        const result = { data: grid.join('\n') };
        frameCache.set(key, result);
        return result;
      }
      
      function renderFrame(frameIndex) {
        console.log('renderFrame called:', frameIndex, frames[frameIndex]);
        if (!frames[frameIndex]) {
          console.error('Frame missing:', frameIndex);
          return;
        }
        const dim = computeDimensions();
        const frame = resampleFrame(frames[frameIndex], dim.width, dim.height);
        ascii.textContent = frame.data;
        ascii.style.opacity = '1';
        ascii.style.background = 'black';
        ascii.classList.add('ready');
      }
      
      async function loadFrames(jsonUrl) {
        try {
          loading.textContent = 'Fetching JSON...';
          const response = await fetch(jsonUrl);
          console.log('Fetch response:', response.status, response.statusText);
          
          if (!response.ok) throw new Error(`HTTP ${response.status}`);
          
          const buffer = await response.arrayBuffer();
          loading.textContent = 'Decompressing...';
          
          const decompressed = pako.inflate(new Uint8Array(buffer));
          const json = new TextDecoder().decode(decompressed);
          frames = JSON.parse(json);
          
          console.log('SUCCESS - Frames loaded:', frames.length);
          console.log('First frame:', frames[0]);
          
          loading.textContent = `✓ ${frames.length} frames loaded`;
          renderFrame(0);
          
          setTimeout(() => {
            loading.style.display = 'none';
            requestAnimationFrame(step);
          }, 1500);
          
        } catch (e) {
          console.error('LOAD ERROR:', e);
          loading.innerHTML = `ERROR: ${e.message}<br>Check Network tab & Console`;
        }
      }
      
      function step(timestamp) {
        if (!playing || frames.length === 0) {
          requestAnimationFrame(step);
          return;
        }
        
        if (!lastTime) {
          lastTime = timestamp;
          requestAnimationFrame(step);
          return;
        }
        
        const deltaTime = timestamp - lastTime;
        if (deltaTime >= frameDuration) {
          videoTime += direction * (frameDuration / 1000);
          
          const duration = frames[frames.length-1]?.timestamp || 10;
          if (videoTime >= duration) {
            videoTime = duration;
            direction = -1;
          } else if (videoTime <= 0) {
            videoTime = 0;
            direction = 1;
          }
          
          let frameIndex = Math.floor(videoTime * FPS);
          frameIndex = Math.max(0, Math.min(frames.length - 1, frameIndex));
          
          renderFrame(frameIndex);
          lastTime = timestamp;
        }
        requestAnimationFrame(step);
      }
      
      // Controls
      container.addEventListener('click', () => {
        playing = !playing;
        console.log('Playback toggled:', playing);
        container.style.opacity = playing ? '1' : '0.7';
      });
      
      window.addEventListener('resize', () => {
        frameCache.clear();
        if (frames.length > 0) renderFrame(0);
      });
      
      // LOAD YOUR JSON FILE HERE
      const JSON_URL = './DSC07313_ascii-frames.json.gz';
      loadFrames(JSON_URL);
    });
  </script>
</body>
</html>
